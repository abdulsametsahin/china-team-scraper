<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Data</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.6.0/css/bootstrap.min.css">
</head>
<body>
<div class="container p-5">
    <div class="row">
        <div class="col-md-12">
            <div class="form-group">
                <label for="company-input">Company ID</label>
                <input type="text" id="company-input" class="form-control" placeholder="Enter company id">
            </div>
        </div>
        <div class="col-md-12">
            <div id="result"></div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        $('#company-input').on('keyup', function (e) {
            if (e.keyCode === 13) {
                const company_id = $(this).val();
                if (company_id.length > 0) {
                    $('#result').html('<div class="alert alert-info" role="alert">Loading...</div>');
                    $.ajax({
                        url: '/api/company/' + company_id,
                        type: 'GET',
                        success: function (data) {
                            if (data.error) {
                                $('#result').html('<div class="alert alert-danger" role="alert">' + data.error + '</div>');
                            } else {
                                const priority = ['company_data', 'annual_reports', 'branches', 'shareholders', 'main_staff', 'foreign_investments'];
                                const sorted = {};
                                priority.forEach(function (key) {
                                    if (data[key]) {
                                        sorted[key] = data[key];
                                        delete data[key];
                                    }
                                });
                                data = {...sorted, ...data};

                                $('#result').html('');
                                Object.keys(data).forEach(function (key) {
                                    // add table for each key and use key values for table data
                                    const item = data[key];

                                    if (!Array.isArray(item)) {
                                        let body = '';

                                        Object.keys(item).forEach(function (key) {
                                            body += '<tr><th>' + key + '</th><td>' + (item[key] || '') + '</td></tr>';
                                        });

                                        $('#result').append('<h2>'+key+'</h2><table class="table table-bordered"><tbody>' + body + '</tbody></table>');
                                    } else {
                                        let head = '';
                                        let body = '';

                                        if (item.length > 0) {
                                            Object.keys(item[0]).forEach(function (key) {
                                                if (key !== 'id' && key !== 'company') {
                                                    head += '<th>' + key + '</th>';
                                                }
                                            });
                                        }

                                        item.forEach(function (item) {
                                            body += '<tr>';
                                            Object.keys(item).forEach(function (key) {
                                                console.log(key);
                                                if (key !== 'id' && key !== 'company') {
                                                    body += '<td>' + (item[key] || '') + '</td>';
                                                }
                                            });
                                            body += '</tr>';
                                        });
                                        if (item.length > 0) {
                                            $('#result').append('<h2>' + key + '</h2><table class="table table-bordered"><thead>' + head + '</thead><tbody>' + body + '</tbody></table>');
                                        }else {
                                            $('#result').append('<h2>' + key + '</h2><div class="alert alert-info" role="alert">No data found</div>');
                                        }
                                    }

                                });
                            }
                        }
                    });
                } else {
                    $('#result').html('');
                }
            }
        });
    });
</script>
</body>
</html>